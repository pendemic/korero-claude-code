#!/bin/bash

# Korero Project Setup Script
# Creates project structure with Korero-specific files in .korero/ subfolder
set -e

PROJECT_NAME=${1:-"my-project"}

echo "ðŸš€ Setting up Korero project: $PROJECT_NAME"

# Create project directory
mkdir -p "$PROJECT_NAME"
cd "$PROJECT_NAME"

# Determine templates directory location (checked AFTER cd into project)
# Check local ../templates first, then global ~/.korero/templates
TEMPLATES_DIR=""
LIB_DIR=""
if [[ -d "../templates" ]]; then
    TEMPLATES_DIR="../templates"
    LIB_DIR="../lib"
elif [[ -d "$HOME/.korero/templates" ]]; then
    TEMPLATES_DIR="$HOME/.korero/templates"
    LIB_DIR="$HOME/.korero/lib"
else
    echo "âŒ Error: Templates directory not found."
    echo "   Expected at: ../templates or ~/.korero/templates"
    echo "   Please run ./install.sh first to install Korero globally."
    exit 1
fi

# Verify required template files exist
if [[ ! -f "$TEMPLATES_DIR/PROMPT.md" ]]; then
    echo "âŒ Error: Required template file PROMPT.md not found in $TEMPLATES_DIR"
    exit 1
fi

# Create structure:
# - src/ stays at root for compatibility with existing tooling
# - All Korero-specific files go in .korero/ subfolder
mkdir -p src
mkdir -p .korero/{specs/stdlib,examples,logs,docs/generated}

# Copy templates to .korero/
cp "$TEMPLATES_DIR/PROMPT.md" .korero/
cp "$TEMPLATES_DIR/fix_plan.md" .korero/fix_plan.md
cp "$TEMPLATES_DIR/AGENT.md" .korero/AGENT.md
cp -r "$TEMPLATES_DIR/specs"/* .korero/specs/ 2>/dev/null || true

# Generate .korerorc configuration file
# Source enable_core.sh if available for generate_korerorc(), otherwise create inline
if [[ -f "$LIB_DIR/enable_core.sh" ]]; then
    # Temporarily disable colors for cleaner output
    export ENABLE_USE_COLORS=false
    source "$LIB_DIR/enable_core.sh"
    # Generate .korerorc and fix the generator label (library says "korero enable")
    generate_korerorc "$PROJECT_NAME" "generic" "local" | sed 's/Generated by: korero enable/Generated by: korero-setup/' > .korerorc
else
    # Fallback: create minimal .korerorc inline (same content as generate_korerorc)
    cat > .korerorc << KORERORCEOF
# .korerorc - Korero project configuration
# Generated by: korero-setup
# Documentation: https://github.com/frankbria/korero-claude-code

# Project identification
PROJECT_NAME="${PROJECT_NAME}"
PROJECT_TYPE="generic"

# Loop settings
MAX_CALLS_PER_HOUR=100
CLAUDE_TIMEOUT_MINUTES=15
CLAUDE_OUTPUT_FORMAT="json"

# Tool permissions
# Comma-separated list of allowed tools
ALLOWED_TOOLS="Write,Read,Edit,Bash(git *),Bash(npm *),Bash(pytest)"

# Session management
SESSION_CONTINUITY=true
SESSION_EXPIRY_HOURS=24

# Task sources (for korero enable --sync)
# Options: local, beads, github (comma-separated for multiple)
TASK_SOURCES="local"
GITHUB_TASK_LABEL="korero-task"
BEADS_FILTER="status:open"

# Circuit breaker thresholds
CB_NO_PROGRESS_THRESHOLD=3
CB_SAME_ERROR_THRESHOLD=5
CB_OUTPUT_DECLINE_THRESHOLD=70
KORERORCEOF
fi

# Initialize git (skip if already initialized)
if [[ ! -d ".git" ]]; then
    git init
fi
echo "# $PROJECT_NAME" > README.md
git add .
git commit -m "Initial Korero project setup"

echo "âœ… Project $PROJECT_NAME created!"
echo "Next steps:"
echo "  1. Edit .korero/PROMPT.md with your project requirements"
echo "  2. Update .korero/specs/ with your project specifications"
echo "  3. Run: ../korero_loop.sh"
echo "  4. Monitor: ../korero_monitor.sh"
